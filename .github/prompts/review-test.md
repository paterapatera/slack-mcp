# テストコードレビュー

## 概要

テストコードの品質、可読性、保守性、効果性に焦点を当てたコードレビューを実施します。テストの命名規則、構造、独立性、モックの使用、アサーションの明確性などを評価し、改善提案を行います。

## パラメータ

| パラメータ | 型     | 必須   | 説明                                                                                                                                                                  |
| ---------- | ------ | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 手順番号   | string | はい   | レビューするチェックリストの番号（例：`all`、`1`、`1.7`、`3.5`など）。チェックリスト全体（`all`）またはカテゴリ全体（`1`）または特定のチェック項目（`1.7`）を指定可能 |
| diff       | string | いいえ | `diff`を指定すると、gitの差分があるファイルのみをレビュー対象とする                                                                                                   |

## 手順

1. **対象ファイルの決定**
   - `diff`フラグが指定されている場合：
     - `git diff HEAD --name-only`を実行して、変更されたファイルのリストを取得する（ステージ済みと未ステージの両方の変更を含む）
     - 取得したファイルのみをレビュー対象とする
   - `diff`フラグが指定されていない場合：
     - ユーザーがディレクトリを指定している場合は、そのディレクトリ内のすべてのファイルをレビュー対象とする
     - ユーザーがファイルを指定している場合は、そのファイルをレビュー対象とする
     - 何も指定されていない場合は、現在開いているファイルをレビュー対象とする
   - **テストコードのみを対象**：
     - 以下の条件に該当するファイルのみをレビュー対象とする：
       - ファイルパスに `test`, `tests`, `__tests__`, `spec`, `specs` が含まれるディレクトリ内のファイル
       - ファイル名に `.test.`, `.spec.` が含まれるファイル（例：`user.test.js`, `user.spec.ts`）
       - ファイル名が `test` または `spec` で始まる、または終わるファイル
     - 上記の条件に該当しないファイルはレビュー対象から除外する

2. **指定された手順番号のチェック項目に基づいたレビュー**
   - 手順番号を解析する：
     - `1.7`のように小数点が含まれる場合：該当する特定のチェック項目（例：1.7）のみを評価する
     - `1`のように整数のみの場合：該当カテゴリ（例：カテゴリ1）のすべてのチェック項目を評価する
     - `all`の場合：チェックリスト全体のすべてのチェック項目を評価する
   - 特定されたチェック項目を対象ファイルに対して評価する
   - 各チェック項目に違反している箇所を特定する

3. **改善提案の提示**
   - 優先度（高/中/低）を付けて、優先度の高い順に並べる
   - 優先度（高/中）のみを表示する
   - 違反内容と改善案のコード例を提示

## 使用例

### 基本的な使用例（カテゴリ1のすべてのチェック項目をレビュー）

```
/review/test 1
```

### 特定のチェック項目をレビュー（1.7のみ）

```
/review/test 1.7
```

### ディレクトリを指定してレビュー

```
/review/test 2 tests/unit
```

### git差分があるファイルのみをレビュー（カテゴリ2のチェック項目）

```
/review/test 2 diff
```

### 特定のチェック項目とgit差分チェックフラグの組み合わせ

```
/review/test 3.5 diff
```

### ディレクトリ指定とgit差分チェックフラグの組み合わせ（diffフラグが優先される）

```
/review/test 4 diff
```

## チェックリスト

**注意**：関数とは、クラスメソッドを含みます。テスト関数とは、`it`, `test`, `describe` などのテストフレームワークの関数を含みます。

- 1 **テストの命名規則**
  - 1.1 テスト名は、何をテストしているのか、どのような条件で、期待される結果は何かを明確に示すこと
  - 1.2 `it`や`test`の説明文は、テストの意図を誤解なく理解できること（「should」や「期待される」などの表現を使うこと）
  - 1.3 `describe`ブロックは、テスト対象の単位（クラス、関数、機能）を明確に示すこと
  - 1.4 テスト名に「test」という単語を含めないこと（例：`testUser`ではなく`user`）
  - 1.5 テスト名は日本語で書くこと（プロジェクトの方針で英語の場合は英語でも可）
  - 1.6 テストデータやモックの変数名は、その用途が明確に分かること（例：`validUser`, `invalidEmail`, `mockRepository`）

- 2 **テストの構造（AAAパターン）**
  - 2.1 テストは Arrange（準備）、Act（実行）、Assert（検証）の3つのセクションに明確に分かれていること
  - 2.2 Arrangeセクションでは、テストに必要なデータやモックの準備のみを行うこと
  - 2.3 Actセクションでは、テスト対象の関数やメソッドの呼び出しのみを行うこと
  - 2.4 Assertセクションでは、期待される結果の検証のみを行うこと
  - 2.5 各セクションの間に空行を入れて視覚的に分離すること
  - 2.6 複数のアサーションがある場合は、関連するアサーションをグループ化すること

- 3 **テストの独立性と隔離**
  - 3.1 各テストは他のテストに依存せず、独立して実行できること
  - 3.2 テスト間で共有される状態（グローバル変数、シングルトンなど）を使わないこと
  - 3.3 `beforeEach`や`afterEach`でテスト間の状態をクリーンアップすること
  - 3.4 テストの実行順序に依存しないこと
  - 3.5 外部リソースへの依存は、テストの種類に応じて適切に扱うこと
    - 単体テストの場合：外部リソース（ファイルシステム、データベース、ネットワーク、外部API）への依存を避け、モックやスタブを使用すること
    - 統合テスト（Featureテスト）の場合：ローカルDB、ローカルRedis、ローカル内のAPI（同じアプリケーション内のAPI）などへのアクセスは許可する（実際のリソースを使用してテストすること）。ただし、外部APIはモックを使用すること

- 4 **モックとスタブの使用**
  - 4.1 モックやスタブは、テスト対象の依存関係のみを置き換えること
  - 4.2 モックの設定は、テストの意図が明確に分かるようにすること
  - 4.3 モックの戻り値や動作は、テストの目的に必要な最小限の設定にすること
  - 4.4 モックの検証（verify）は、本当に検証すべき呼び出しのみを検証すること
  - 4.5 モックの過度な使用を避け、可能な限り実際のオブジェクトを使用すること（統合テストの場合）
  - 4.6 モックの設定と検証は、テストの意図を明確にするためにコメントを追加すること（複雑な場合）

- 5 **アサーションの明確性**
  - 5.1 アサーションのメッセージは、失敗時に何が期待されていたのか、実際の値は何だったのかを明確に示すこと
  - 5.2 1つのテストで検証するアサーションは、関連する1つの動作や結果に絞ること
  - 5.3 複数のアサーションが必要な場合は、それぞれのアサーションが何を検証しているのか明確にすること
  - 5.4 カスタムアサーションやマッチャーを使用して、意図を明確にすること
  - 5.5 否定のアサーション（`not.toBe`など）を使う場合は、その意図が明確であること

- 6 **テストデータの準備**
  - 6.1 テストデータは、テストの意図が明確に分かるように命名すること
  - 6.2 テストデータの準備は、テストファクトリやビルダーパターンを使用して簡潔にすること
  - 6.3 テストデータは、テストに必要な最小限の属性のみを含めること
  - 6.4 テストデータの値は、その値が選ばれた理由が明確であること（マジックナンバーを避ける）
  - 6.5 テストデータの再利用が必要な場合は、ヘルパー関数やファクトリを作成すること

- 7 **テストの可読性**
  - 7.1 テストコードは、実装コードよりも読みやすく、理解しやすくすること
  - 7.2 複雑なテストロジックは、ヘルパー関数やユーティリティ関数に抽出すること
  - 7.3 テストの意図が分かりづらい場合は、コメントを追加すること
  - 7.4 テストの構造は、ネストを浅くすること（`describe`のネストは2階層までを推奨）
  - 7.5 長いテスト（20行以上）は、複数の小さなテストに分割できないか検討すること

- 8 **テストカバレッジと網羅性**
  - 8.1 正常系のテストだけでなく、異常系のテストも含まれていること
  - 8.2 境界値のテストが含まれていること（例：空文字列、null、最大値、最小値）
  - 8.3 エラーケースのテストが含まれていること（例：例外の発生、エラーレスポンス）
  - 8.4 エッジケースのテストが考慮されていること
  - 8.5 テストが網羅的であること（すべての分岐がテストされていること）

- 9 **テストのパフォーマンス**
  - 9.1 テストの実行時間が適切であること（単体テストは1秒以内、統合テストは10秒以内を目安）
  - 9.2 不要な待機時間（`sleep`、`setTimeout`など）を避けること
  - 9.3 テストデータの準備が効率的であること（必要以上に大きなデータセットを使わない）
  - 9.4 並列実行を考慮したテスト設計になっていること

- 10 **テストの保守性**
  - 10.1 テストコードの重複を避け、共通の処理はヘルパー関数に抽出すること
  - 10.2 テストの設定やフィクスチャは、再利用可能な形で整理すること
  - 10.3 テストが壊れやすい（brittle）設計になっていないこと（実装の詳細に依存しすぎない）
  - 10.4 テストの意図が変更された場合は、テスト名やコメントも更新すること
  - 10.5 不要になったテストや、重複するテストは削除すること
