# アーキテクチャコードレビュー

## 概要

コンポーネントレベルのアーキテクチャ設計に焦点を当てたコードレビューを実施します。閉鎖性共通の原則（CCP）、再利用・リリース等価の原則（REP）、全再利用の原則（CRP）の3つの原則に基づいて、コンポーネントの凝集性、依存関係、再利用性を評価し、改善提案を行います。

## パラメータ
| パラメータ | 型 | 必須 | 説明 |
|----------|-----|------|------|
| 原則 | string | いいえ | 評価する原則を指定（`CCP`、`REP`、`CRP`、または`all`）。指定がない場合は`all`として全原則を評価 |
| diff | string | いいえ | `diff`を指定すると、gitの差分があるファイルのみをレビュー対象とする |

## 手順

1. **対象ファイルの決定**
   - `diff`フラグが指定されている場合：
     - `git diff HEAD --name-only`を実行して、変更されたファイルのリストを取得する（ステージ済みと未ステージの両方の変更を含む）
     - 取得したファイルのみをレビュー対象とする
   - `diff`フラグが指定されていない場合：
     - ユーザーがディレクトリを指定している場合は、そのディレクトリ内のすべてのファイルをレビュー対象とする
     - ユーザーがファイルを指定している場合は、そのファイルをレビュー対象とする
     - 何も指定されていない場合は、プロジェクト全体をレビュー対象とする
   - **テストコードの除外**：
     - 以下の条件に該当するファイルはレビュー対象から除外する：
       - ファイルパスに `test`, `tests`, `__tests__`, `spec`, `specs` が含まれるディレクトリ内のファイル
       - ファイル名に `.test.`, `.spec.` が含まれるファイル（例：`user.test.js`, `user.spec.ts`）
       - ファイル名が `test` または `spec` で始まる、または終わるファイル

2. **コンポーネント構造の分析**
   - プロジェクトのディレクトリ構造を分析し、コンポーネント（モジュール、パッケージ、ディレクトリ）を特定する
   - 各コンポーネントに含まれるクラス、モジュール、ファイルをリストアップする
   - コンポーネント間の依存関係をマッピングする
   - 各コンポーネントの変更履歴や変更頻度を分析する（可能な場合）

3. **指定された原則に基づいたレビュー**
   - 原則パラメータを解析する：
     - `CCP`が指定された場合：閉鎖性共通の原則のみを評価する
     - `REP`が指定された場合：再利用・リリース等価の原則のみを評価する
     - `CRP`が指定された場合：全再利用の原則のみを評価する
     - `all`が指定された場合、または指定がない場合：3つの原則すべてを評価する
   - 各原則に基づいてコンポーネント構造を評価する

4. **原則別の評価と改善提案**
   - **閉鎖性共通の原則（CCP）の評価**：
     - 同じ理由、同じタイミングで変更されるクラスが同じコンポーネントにまとまっているか
     - 変更の理由やタイミングが異なるクラスが別のコンポーネントに分かれているか
     - 違反している箇所を特定し、改善案を提示する
   - **再利用・リリース等価の原則（REP）の評価**：
     - コンポーネントが一貫するテーマや目的を持つクラスやモジュールで構成されているか
     - コンポーネントがまとめてリリース可能な単位になっているか
     - 違反している箇所を特定し、改善案を提示する
   - **全再利用の原則（CRP）の評価**：
     - 一緒に用いられることが多いクラスやモジュールが同じコンポーネントにまとまっているか
     - コンポーネントのユーザーが使わないクラスへの依存を強要されていないか
     - 違反している箇所を特定し、改善案を提示する

5. **改善案の統合とスコアリング**
   - 各原則に基づいた改善案を統合する
   - 各改善案に対してスコアを付与する：
     - 影響範囲（高/中/低）
     - 実装難易度（高/中/低）
     - 期待される効果（高/中/低）
   - 総合スコアを計算し、最もスコアの高い改善案を推奨する

6. **改善提案の提示**
   - 最も重要な10件のみを表示する（指摘が多すぎると見づらくなるため）
   - 優先度（高/中/低）を付けて、優先度の高い順に並べる
   - 各原則に基づいた改善案を明確に分類して提示
   - 推奨改善案を最初に提示し、その理由を説明
   - 具体的な改善案をコード例や構造図と共に提示
   - 改善によるメリットを説明

## 使用例
### 基本的な使用例（全原則を評価）
```
/review/architecture
```

### 特定の原則を評価（CCPのみ）
```
/review/architecture CCP
```

### ディレクトリを指定してレビュー
```
/review/architecture all src/components
```

### git差分があるファイルのみをレビュー
```
/review/architecture diff
```

### 特定の原則とgit差分チェックフラグの組み合わせ
```
/review/architecture REP diff
```

## 評価原則

### 閉鎖性共通の原則（CCP）
同じ理由、同じタイミングで変更されるクラスをコンポーネントにまとめること。
変更の理由やタイミングが異なるクラスは、別のコンポーネントに分けること。

**評価観点**：
- 同じビジネス要件や技術的要件によって変更されるクラスが同じコンポーネントに属しているか
- 変更履歴が類似しているクラスが同じコンポーネントに属しているか
- 変更の理由が異なるクラスが別のコンポーネントに分かれているか

**違反の例**：
- データベーススキーマ変更とUI変更が同じコンポーネントに含まれている
- 認証ロジックとレポート生成ロジックが同じコンポーネントに含まれている

### 再利用・リリース等価の原則（REP）
再利用の単位とリリースの単位は等価になること。

**評価観点**：
- コンポーネントが一貫するテーマや目的を持つクラスやモジュールで構成されているか
- コンポーネントがまとめてリリース可能な単位になっているか
- コンポーネントに含まれるクラスやモジュールが適当に寄せ集められていないか

**違反の例**：
- 関連性のないクラスが同じコンポーネントに含まれている
- リリース頻度が大きく異なるクラスが同じコンポーネントに含まれている

### 全再利用の原則（CRP）
コンポーネントのユーザーに対して、実際には使わないものへの依存を強要しないこと。

**評価観点**：
- 一緒に用いられることが多いクラスやモジュールが同じコンポーネントにまとまっているか
- コンポーネントのユーザーが使わないクラスへの依存を強要されていないか
- 密結合していないクラスが同じコンポーネントにまとめられていないか

**違反の例**：
- コンテナクラスとイテレータが別のコンポーネントに分かれている
- コンポーネントの一部のクラスだけを使いたいのに、全体に依存する必要がある

## 改善案のスコアリング基準

各改善案に対して以下の基準でスコアを付与します：

### 影響範囲
- **高**：複数のコンポーネントに影響し、大規模なリファクタリングが必要
- **中**：1〜2つのコンポーネントに影響し、中規模のリファクタリングが必要
- **低**：単一のコンポーネント内での変更で済む

### 実装難易度
- **高**：複雑な依存関係の解決や大規模なコード移動が必要
- **中**：中程度のリファクタリングと依存関係の調整が必要
- **低**：簡単なファイル移動や軽微な修正で済む

### 期待される効果
- **高**：アーキテクチャの品質が大幅に向上し、保守性が大きく改善される
- **中**：アーキテクチャの品質が中程度向上し、保守性が改善される
- **低**：アーキテクチャの品質が軽微に向上する

### 総合スコアの計算
各評価項目を数値化（高=3、中=2、低=1）し、以下の式で計算：
```
総合スコア = (期待される効果 × 2) - (実装難易度 × 1.5) - (影響範囲 × 0.5)
```

最もスコアの高い改善案を推奨改善案として提示します。
