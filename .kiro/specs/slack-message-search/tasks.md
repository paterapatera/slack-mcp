# Implementation Plan

## 1. プロジェクトセットアップと開発環境の構築

- [x] 1.1 (P) TypeScript と Bun の開発環境をセットアップする
  - package.json に必要な依存関係を追加（@modelcontextprotocol/server、@slack/bolt、TypeScript）
  - Bun のビルド設定を構成し、TypeScript をコンパイルできるようにする
  - TypeScript の設定ファイル（tsconfig.json）を作成し、strict mode を有効化する
  - 型定義ファイルの出力先を設定する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 1.2 (P) npm link 対応のための package.json 設定を行う
  - package.json に main フィールドを設定し、エントリーポイントを指定する
  - bin フィールドを設定し、CLI コマンドとして実行可能にする（必要に応じて）
  - npm link でリンク可能な形式に package.json を構成する
  - _Requirements: 5.6, 5.7, 5.8_

## 2. Config Service の実装

- [x] 2.1 環境変数の読み込み機能を実装する
  - process.env から SLACK_USER_TOKEN、SLACK_TEAM_ID、SLACK_CHANNEL_IDS を読み込む
  - SLACK_CHANNEL_IDS をカンマ区切りリストとしてパースする
  - 環境変数の型変換ロジックを実装する
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 2.2 環境変数の検証機能を実装する
  - SLACK_USER_TOKEN の存在確認を実行する（必須）
  - SLACK_TEAM_ID と SLACK_CHANNEL_IDS の形式検証を実装する（オプション）
  - 検証失敗時に ConfigError を throw し、明確なエラーメッセージを生成する
  - 統一エラーハンドリング戦略に基づき、起動を中止するエラーハンドリングを実装する
  - _Requirements: 2.2, 4.5_

## 3. Slack API Client の実装

- [x] 3.1 @slack/bolt を使用した Slack API クライアントの初期化を実装する
  - initialize(token) メソッドを実装し、Bolt アプリを初期化する
  - 起動時に Slack API への接続テストを実行する（オプション、実装時に決定）
  - 接続失敗時に起動を中止するエラーハンドリングを実装する
  - 統一エラーハンドリング戦略に基づき、エラーメッセージを生成する
  - _Requirements: 2.1, 2.2_

- [x] 3.2 メッセージ検索 API 呼び出し機能を実装する
  - searchMessages(options) メソッドを実装し、app.client.search.messages() を呼び出す
  - Slack API レスポンスを型安全に変換する
  - API レスポンスの型定義を実装する
  - _Requirements: 2.3, 3.1_

- [x] 3.3 レート制限とリトライロジックを実装する
  - Slack API のレート制限エラーを検出する
  - 指数バックオフによるリトライロジックを実装する
  - リトライ試行回数と待機時間をログに記録する
  - 統一エラーハンドリング戦略に基づき、最終的に失敗した場合はエラーレスポンスを返却する
  - _Requirements: 2.5, 6.2_

- [x] 3.4 認証エラーと接続エラーのハンドリングを実装する
  - 認証エラーを検出し、適切なエラーメッセージを生成する
  - 接続失敗やタイムアウトエラーを検出し、リトライロジックを実行する
  - 統一エラーハンドリング戦略に基づき、エラーをログに記録する（トークン情報は含めない）
  - _Requirements: 2.4, 6.1, 6.5_

## 4. Search Service の実装

- [x] 4.1 検索クエリの処理と Slack API への委譲を実装する
  - searchMessages(options) メソッドを実装する
  - 検索クエリの検証を実装する（空のクエリの場合はエラーを返却）
  - Slack API Client を呼び出して検索を実行する
  - 統一エラーハンドリング戦略に基づき、ルール違反の場合はエラーレスポンスを返却する
  - _Requirements: 3.1, 3.7_

- [x] 4.2 チャンネルIDによる検索範囲の制限機能を実装する
  - SLACK_CHANNEL_IDS が設定されている場合、検索を指定されたチャンネルIDに限定する
  - チャンネルIDが未提供の場合は、全チャンネルでの検索を実行する
  - 無効なチャンネルIDを検出し、有効なチャンネルでの検索を継続する（Graceful Degradation）
  - 統一エラーハンドリング戦略に基づき、無効なチャンネルIDを警告としてログに記録する
  - _Requirements: 3.2, 3.3, 4.4, 6.3_

- [x] 4.3 ワークスペーススコープ機能を実装する
  - SLACK_TEAM_ID が提供されている場合、検索を指定されたチーム/ワークスペースにスコープする
  - チームIDを検索オプションに含める
  - _Requirements: 3.4_

- [x] 4.4 検索結果の整形と構造化を実装する
  - Slack API レスポンスを内部形式（Message、SearchResult）に変換する
  - メッセージ内容、タイムスタンプ、チャンネル情報、ユーザー情報を含む構造化された形式で返却する
  - タイムスタンプを ISO 8601 形式に変換する
  - 空の結果セットを適切な形式で返却する
  - _Requirements: 3.5, 3.6_

## 5. MCP Server の実装

- [x] 5.1 MCP プロトコルの基本実装を行う
  - @modelcontextprotocol/server を使用して MCP Server を初期化する
  - StdioServerTransport を設定し、標準入出力経由で通信する
  - MCP プロトコル仕様に準拠した実装を行う
  - _Requirements: 1.1_

- [x] 5.2 起動時の初期化フローを実装する
  - Config Service の load() と validate() を実行し、環境変数を検証する
  - Slack API Client の initialize(token) を実行し、Slack API への接続を確認する
  - 起動時エラーをキャッチし、統一エラーハンドリング戦略に基づき起動を中止する
  - _Requirements: 1.2, 2.2, 4.5_

- [x] 5.3 search_messages ツールの登録とハンドリングを実装する
  - search_messages ツールを登録し、ツールの説明を定義する
  - ツールハンドラーを実装し、MCP リクエストを受け取る
  - Config Service から設定情報を取得し、Search Service に設定値を注入する
  - Search Service の searchMessages() を呼び出し、検索結果を取得する
  - 検索結果を MCP レスポンス形式に変換し、MCP クライアントに返却する
  - _Requirements: 1.3, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 4.4_

- [x] 5.4 MCP リクエストの検証とエラーハンドリングを実装する
  - MCP リクエスト形式の検証を実装する
  - 無効なリクエストに対して適切な MCP エラーレスポンス（-32600 Invalid Request など）を返却する
  - 予期しないエラーをキャッチし、適切なエラーレスポンスに変換する
  - 統一エラーハンドリング戦略に基づき、エラーをログに記録する
  - _Requirements: 1.4, 6.5_

- [x] 5.5 同時リクエストの処理を実装する
  - 複数の MCP クライアントからの同時リクエストを処理できるようにする
  - 非同期処理により、複数の検索リクエストを並行して処理する
  - _Requirements: 1.5_

## 6. ログ記録機能の実装

- [x] 6.1 (P) ログ記録機能を実装する
  - エラーと重要なイベントをログに記録する機能を実装する
  - 認証エラー、API エラー、レート制限エラーをログに記録する
  - 検索リクエストの成功/失敗率を追跡する
  - 統一エラーハンドリング戦略に基づき、エラーの種類、発生箇所、コンテキスト情報を含める
  - _Requirements: 6.4_

## 7. 統合とテスト

- [x] 7.1 起動フローの統合テストを実装する
  - 環境変数の読み込みと検証の統合テストを実装する
  - Slack API Client の初期化の統合テストを実装する
  - 起動時のエラーハンドリングのテストを実装する
  - _Requirements: 1.2, 2.2, 4.5_

- [x] 7.2 メッセージ検索フローの統合テストを実装する
  - MCP Server と Search Service の統合テストを実装する
  - Search Service と Slack API Client の統合テストを実装する
  - エンドツーエンドの検索リクエストフローのテストを実装する
  - _Requirements: 1.3, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 7.3 MCP Inspector を使用した E2E テストを実装する
  - MCP Inspector でサーバーの動作を検証するテストを実装する
  - MCP クライアントからの検索リクエストのテストを実装する
  - 実際の Slack API を使用した検索テストを実装する（テスト用トークンを使用）
  - _Requirements: 1.1, 1.3, 2.3, 3.1_

- [x] 7.4 エラーハンドリングのテストを実装する
  - 起動時エラー（環境変数未設定、Slack API 接続失敗）のテストを実装する
  - リクエスト時エラー（無効なリクエスト、認証エラー）のテストを実装する
  - レート制限エラー時のリトライロジックのテストを実装する
  - 無効なチャンネルIDの処理のテストを実装する
  - _Requirements: 1.4, 2.4, 2.5, 6.1, 6.2, 6.3, 6.5_

- [x] 7.5 パフォーマンステストを実装する
  - 同時リクエストの処理のテストを実装する
  - レート制限対応のテストを実装する
  - _Requirements: 1.5, 2.5_
